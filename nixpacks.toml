[phases.setup]
nixPkgs = ["git", "git-lfs", "nodejs-18_x"]

[phases.install]
cmds = [
  "echo '=== Installing Git LFS ==='",
  "git lfs install || true",
  "echo '=== Checking Git LFS status ==='",
  "git lfs ls-files | head -10 || echo 'No LFS files tracked'",
  "echo '=== Pulling Git LFS files ==='",
  "git lfs pull --all 2>&1",
  "LFS_EXIT=$?",
  "echo 'Git LFS pull exit code:' $LFS_EXIT",
  "if [ $LFS_EXIT -ne 0 ]; then echo 'âš ï¸  WARNING: Git LFS pull failed. This may be normal if Railway does not support Git LFS.'; fi",
  "echo '=== Verifying LFS files were pulled ==='",
  "cd server/uploads/videos 2>/dev/null || mkdir -p server/uploads/videos",
  "cd server/uploads/videos",
  "LFS_POINTERS=0",
  "REAL_FILES=0",
  "for file in *.mp4 *.webm *.mov 2>/dev/null; do",
  "  if [ -f \"$file\" ]; then",
  "    size=$(stat -f%z \"$file\" 2>/dev/null || stat -c%s \"$file\" 2>/dev/null || echo 0)",
  "    if [ \"$size\" -lt 200 ]; then",
  "      content=$(head -c 100 \"$file\" 2>/dev/null || echo '')",
  "      if echo \"$content\" | grep -q 'version https://git-lfs.github.com/spec/v1'; then",
  "        echo \"âš ï¸  LFS POINTER: $file (${size} bytes)\"",
  "        LFS_POINTERS=$((LFS_POINTERS + 1))",
  "      fi",
  "    else",
  "      size_mb=$(echo \"scale=2; $size / 1048576\" | bc 2>/dev/null || echo \"$(($size / 1048576))\")",
  "      echo \"âœ… REAL FILE: $file (${size_mb} MB)\"",
  "      REAL_FILES=$((REAL_FILES + 1))",
  "    fi",
  "  fi",
  "done",
  "echo ''",
  "echo 'ðŸ“Š Video Files Summary:'",
  "echo \"  Real video files: $REAL_FILES\"",
  "echo \"  LFS pointer files: $LFS_POINTERS\"",
  "if [ \"$LFS_POINTERS\" -gt 0 ]; then",
  "  echo ''",
  "  echo 'âš ï¸  WARNING: Some video files are LFS pointers and may not work correctly.'",
  "  echo '   Consider using Railway Volumes or external storage for video files.'",
  "fi",
  "cd ../..",
  "echo '=== Checking video files ==='",
  "ls -la server/uploads/videos/ 2>&1 | head -15 || echo 'Video directory not found'",
  "VIDEO_COUNT=$(find server/uploads/videos -name '*.mp4' -o -name '*.webm' -o -name '*.mov' 2>/dev/null | wc -l)",
  "echo \"Total video files found: $VIDEO_COUNT\"",
  "echo '=== Installing server dependencies ==='",
  "npm install --prefix server || exit 1",
  "echo '=== Installing client dependencies ==='",
  "npm install --prefix client || exit 1"
]

[phases.build]
cmds = ["npm run build --prefix client"]

[start]
cmd = "cd server && node index.js"

